name: Release (tag)

on:
  push:
    tags:
      - '*'

permissions:
  contents: read
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # éœ€è¦ä¸Šä¸€å€‹ commit ä¾†æª¢æŸ¥ CHANGELOG æ˜¯å¦æœ‰æ›´æ–°
          fetch-depth: 2

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type Check
        run: npm run tsc

      - name: Test
        run: npm test

      - name: Build
        run: npm run build

      # -------------------------
      # ğŸš§ Release Safety Gates
      # -------------------------

      - name: Ensure tag version matches package.json version
        shell: bash
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"

          # å¾ tag ä¸­æŠ“å‡ºç¬¬ä¸€å€‹ç¬¦åˆ semver çš„ç‰‡æ®µï¼ˆx.y.zï¼‰
          # å¯æ”¯æ´ï¼š
          # - 0.1.0
          # - @kekkai/structure-lint@0.1.0
          # - release-0.1.0
          TAG_VERSION="$(echo "$TAG_NAME" | grep -Eo '[0-9]+\.[0-9]+\.[0-9]+' | head -n 1)"

          if [ -z "$TAG_VERSION" ]; then
            echo "âŒ Cannot parse semver (x.y.z) from tag: $TAG_NAME"
            exit 1
          fi

          PKG_VERSION="$(node -p "require('./package.json').version")"

          if [ "$TAG_VERSION" != "$PKG_VERSION" ]; then
            echo "âŒ Tag version ($TAG_VERSION) does not match package.json version ($PKG_VERSION)"
            exit 1
          fi

          echo "âœ… Tag version matches package.json: $TAG_VERSION"

      - name: Ensure CHANGELOG.md was updated in the release commit
        shell: bash
        run: |
          # æª¢æŸ¥ tag æŒ‡åˆ°çš„ commit èˆ‡å®ƒçš„ä¸Šä¸€å€‹ commit ä¹‹é–“ï¼Œæœ‰æ²’æœ‰ä¿®æ”¹ CHANGELOG.md
          if ! git diff --name-only HEAD^ HEAD | grep -q '^CHANGELOG\.md$'; then
            echo "âŒ CHANGELOG.md was not updated in this release commit."
            echo "Fix: run 'npx changeset version' then commit, then create/push the tag again."
            exit 1
          fi

          echo "âœ… CHANGELOG.md updated"

      - name: Ensure all changesets are consumed
        shell: bash
        run: |
          # changeset version æ­£å¸¸æƒ…æ³æœƒæ¶ˆè€—ï¼ˆåˆªé™¤ï¼‰.changeset/*.md
          # è‹¥é‚„æ®˜ç•™ï¼Œä»£è¡¨æœ‰äººæ²’è·‘ version æˆ–æ¼è™•ç†
          if [ -d ".changeset" ]; then
            # æ’é™¤ config.json / README.md ç­‰éè®Šæ›´æª”
            PENDING="$(find .changeset -maxdepth 1 -type f -name '*.md' | wc -l | tr -d ' ')"
            if [ "$PENDING" != "0" ]; then
              echo "âŒ Unreleased changesets detected: $PENDING file(s) in .changeset/"
              echo "Fix: run 'npx changeset version' then commit, then create/push the tag again."
              exit 1
            fi
          fi

          echo "âœ… No pending changesets"

      # -------------------------
      # ğŸš€ Publish
      # -------------------------

      - name: Publish to npm
        run: npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
